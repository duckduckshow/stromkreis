<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Stromkreis-Lernspiel ‚Äì kompakt, Mission & Diagnose</title>
<style>
  *{box-sizing:border-box;font-family:system-ui,-apple-system,Segoe UI,sans-serif}
  body{margin:0;background:#f3f3f3;display:flex;justify-content:center}
  .app{
    width:100%;max-width:1040px;background:#fff;margin:10px;padding:10px;
    border-radius:12px;box-shadow:0 2px 10px rgba(0,0,0,.08)
  }
  h1{margin:4px 0 8px;text-align:center;font-size:17px}

  .top{display:flex;justify-content:space-between;align-items:center;gap:8px;flex-wrap:wrap}
  .pill{
    display:inline-flex;align-items:center;gap:8px;
    padding:5px 9px;border-radius:999px;border:1px solid #ddd;background:#fafafa;
    font-weight:900;font-size:12px;color:#222
  }

  .grid{margin-top:10px;display:grid;grid-template-columns: 280px 1fr;gap:10px}
  @media (max-width:920px){.grid{grid-template-columns:1fr}}

  .card{border:1px solid #e5e5e5;border-radius:12px;background:#fcfcfc;padding:10px}
  .title{font-weight:1100;margin-bottom:8px;font-size:13px}
  .small{font-size:12px;color:#555;font-weight:800;line-height:1.25}

  .btnRow{display:flex;gap:6px;flex-wrap:wrap}
  .btn{
    border:none;border-radius:10px;padding:9px 10px;
    font-weight:1100;cursor:pointer;font-size:12px;
    background:#007bff;color:#fff
  }
  .btn:hover{background:#0062cc}
  .btn.secondary{background:#222}
  .btn.secondary:hover{background:#000}
  .btn.ghost{background:#fff;color:#111;border:1px solid #ddd}
  .btn.ghost:hover{background:#f3f3f3}
  .btn:disabled{opacity:.55;cursor:not-allowed}

  .section{margin-top:10px}
  .label{font-weight:1100;font-size:12px;color:#333;margin-bottom:6px}

  /* ===== Board ===== */
  .board{
    position:relative;
    border:1px solid #ddd;border-radius:12px;background:#fff;
    padding:10px;min-height:240px;overflow:hidden
  }
  .boardGrid{
    position:absolute;inset:0;
    background-image: radial-gradient(circle at 1px 1px, rgba(0,0,0,.05) 1px, transparent 0);
    background-size:18px 18px;
    opacity:.65;pointer-events:none;
  }

  .circuitRow{
    position:relative;z-index:1;
    display:flex;align-items:center;gap:8px;flex-wrap:nowrap;
    padding:18px 10px 10px;
  }
  @media (max-width:920px){.circuitRow{flex-wrap:wrap}}

  .wireFlex{
    flex:1 1 36px;
    height:5px;border-radius:999px;
    background:linear-gradient(90deg,#222,#444);
    box-shadow: inset 0 0 0 1px rgba(255,255,255,.10);
    min-width:18px;
  }

  .battery{
    width:118px;height:50px;border-radius:12px;
    background:linear-gradient(180deg,#ffd27f,#ffbe55);
    border:2px solid #333;
    display:flex;align-items:center;justify-content:space-between;
    padding:8px 10px;gap:8px
  }
  .battery .cap{width:14px;height:24px;border-radius:6px;background:#555;border:2px solid #333}
  .battery .labelV{font-weight:1100;font-size:13px}
  .battery .sub{font-size:11px;font-weight:900;color:#333}

  .placeholder{
    border:2px dashed #bbb;border-radius:12px;padding:10px 12px;background:#fafafa;
    font-weight:1100;color:#666;font-size:12px;white-space:nowrap
  }

  .resistor{
    width:128px;height:42px;border-radius:12px;
    border:2px solid #333;background:#fff;
    display:flex;align-items:center;justify-content:space-between;
    padding:6px 8px;gap:8px;position:relative;
  }
  .resistor .lead{width:18px;height:5px;border-radius:999px;background:#666}
  .resistor .body{
    flex:1;height:20px;border-radius:999px;border:2px solid #333;
    background:linear-gradient(180deg,#f1d7b2,#d9b483);
    position:relative;
  }
  .band{position:absolute;top:0;bottom:0;width:8px;border-radius:6px;opacity:.95}
  .resistor .ohm{
    position:absolute;right:7px;top:50%;transform:translateY(-50%);
    font-weight:1100;font-size:11px;background:rgba(255,255,255,.85);
    border:1px solid rgba(0,0,0,.15);border-radius:999px;padding:2px 7px;
  }

  .lampWrap{display:flex;flex-direction:column;align-items:center;gap:6px;min-width:90px}
  .lamp{
    width:74px;height:74px;border-radius:999px;
    border:2px solid #333;background:#f8f8f8;
    display:flex;align-items:center;justify-content:center;
    position:relative;
  }
  .lamp:before{
    content:"";
    position:absolute;inset:7px;border-radius:999px;
    background:radial-gradient(circle at 35% 35%, rgba(255,255,255,.95), rgba(255,255,255,.25));
    border:1px solid rgba(0,0,0,.08);
  }
  .lampCore{width:20px;height:20px;border-radius:999px;background:#999;z-index:1}
  .lampPct{font-size:12px;font-weight:1100}
  .lampLabel{font-size:11px;font-weight:900;color:#333}

  .meters{margin-top:10px;display:grid;grid-template-columns: 1fr 1fr 1fr;gap:10px}
  @media (max-width:920px){.meters{grid-template-columns: 1fr}}
  .mCard{background:#fff;border:1px solid #e5e5e5;border-radius:12px;padding:10px}
  .mTitle{font-weight:1100;font-size:12px;margin-bottom:6px}
  .big{font-size:20px;font-weight:1200}
  .bar{height:10px;border-radius:999px;background:#eee;overflow:hidden;border:1px solid #ddd;margin-top:8px}
  .fill{height:100%;width:0%;background:#111;transition:width .25s ease}

  .ok{color:#1b7f3a}
  .bad{color:#b3261e}
  .low{color:#005bbb}
  .warn{color:#a05a00}

  .heatBox{
    margin-top:8px;padding:8px;border-radius:12px;
    border:1px solid #ffccaa;background:#fff4ec;color:#7a2c00;font-weight:1100;
    display:none
  }
  .heatBox.show{display:block}

  .taskBox{margin-top:8px;background:#fff;border:1px solid #e5e5e5;border-radius:12px;padding:9px}
  .taskTitle{font-weight:1200;font-size:13px;margin-bottom:4px}
  .taskTitle .mission{font-weight:1300}
  .badges{display:flex;gap:6px;flex-wrap:wrap;margin-top:6px}
  .badge{
    padding:4px 9px;border-radius:999px;border:1px solid #ddd;background:#fafafa;
    font-weight:1100;font-size:11px;
  }

  .mc{margin-top:10px;background:#fff;border:1px solid #e5e5e5;border-radius:12px;padding:9px}
  .mcTitle{font-weight:1200;font-size:13px;margin-bottom:6px}
  .opt{
    border:1px solid #ddd;border-radius:12px;padding:9px;background:#fafafa;
    cursor:pointer;font-weight:1100;font-size:12px;margin-top:7px
  }
  .opt:hover{background:#f2f2f2}
  .opt.correct{background:#d4edda;border-color:#28a745}
  .opt.wrong{background:#f8d7da;border-color:#dc3545}
  .opt.disabled{pointer-events:none;opacity:.95}

  .controls{display:flex;justify-content:space-between;gap:8px;flex-wrap:wrap;margin-top:10px}

  .resultBox{
    margin-top:8px;
    background:#fff;border:1px solid #e5e5e5;border-radius:12px;padding:9px;
    display:none;
  }
  .resultBox.show{display:block}
  .resultLine{font-weight:1100;font-size:12px;color:#222;line-height:1.25}
  .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace}
</style>
</head>

<body>
<div class="app">
  <h1>Stromkreis-Lernspiel ‚ö° (kompakt)</h1>

  <div class="top">
    <div class="pill">Level: <b id="levelLabel">1</b></div>
    <div class="pill">Modus: <b id="modeLabel">Bauen</b></div>
    <div class="pill">Zielstrom: <b id="targetLabel">‚Äì</b> (¬± <span id="tolLabel">‚Äì</span>)</div>
    <div class="pill">Punkte: <b id="scoreLabel">0</b></div>
  </div>

  <div class="grid">
    <!-- LEFT -->
    <div class="card">
      <div class="title">Bauteile</div>

      <div class="section">
        <div class="label">Batterien</div>
        <div class="btnRow" id="voltageBtns"></div>
        <div class="small" id="lockInfoV" style="margin-top:6px"></div>
      </div>

      <div class="section">
        <div class="label">Widerst√§nde (Reihe)</div>
        <div class="btnRow" id="resBtns"></div>
        <div class="small" id="lockInfoR" style="margin-top:6px"></div>
      </div>

      <div class="section btnRow">
        <button class="btn ghost" id="undoBtn">Undo</button>
        <button class="btn secondary" id="resetBtn">Reset</button>
      </div>

      <div class="taskBox">
        <div class="taskTitle" id="taskTitle">Aufgabe</div>
        <div class="badges" id="taskBadges"></div>
        <div class="small" id="taskHint" style="margin-top:6px"></div>
        <div class="small" style="margin-top:8px">
          <b>Didaktik:</b> Erst <b>R gesamt</b> (addieren), dann <b>I = U/R</b>.
        </div>
      </div>

      <div class="mc" id="mcBox" style="display:none">
        <div class="mcTitle" id="mcTitle">Fehlerdiagnose</div>
        <div id="mcOpts"></div>
        <div class="small" id="mcHint" style="margin-top:8px"></div>
      </div>
    </div>

    <!-- RIGHT -->
    <div class="card">
      <div class="title">Schaltkreis</div>

      <div class="board" id="board">
        <div class="boardGrid"></div>
        <div class="circuitRow" id="circuitRow"></div>
      </div>

      <div class="meters">
        <div class="mCard">
          <div class="mTitle">Strom</div>
          <div class="big" id="iNow">‚Äì</div>
          <div class="bar"><div class="fill" id="iFill"></div></div>
          <div class="small" id="iHint" style="margin-top:8px"></div>
        </div>

        <div class="mCard">
          <div class="mTitle">Lampe</div>
          <div class="big" id="lampState">‚Äì</div>
          <div class="bar"><div class="fill" id="lampFill"></div></div>
          <div class="small" style="margin-top:8px">Helligkeit: <b id="lampPct">0%</b></div>
        </div>

        <div class="mCard">
          <div class="mTitle">W√§rme</div>
          <div class="bar"><div class="fill" id="heatFill"></div></div>
          <div class="heatBox" id="overheatBox">√úberhitzt! ‚ö†Ô∏è Weniger U oder mehr R.</div>
          <div class="small" style="margin-top:8px">Ziel: nicht √ºberhitzen.</div>
        </div>
      </div>

      <div class="controls">
        <button class="btn" id="checkBtn">Pr√ºfen</button>
        <button class="btn" id="nextBtn" disabled>Weiter</button>
      </div>

      <div class="resultBox" id="resultBox">
        <div class="resultLine" id="calcLine"></div>
        <div class="resultLine" id="pointsLine" style="margin-top:6px"></div>
      </div>
    </div>
  </div>
</div>

<script>
/* =========================
   Bauteile
========================= */
const VOLTAGES = [1.5, 3, 4.5, 6, 9, 12];
const RESISTORS = [1, 2.2, 2.7, 3.3, 4.7, 5.6, 6.8, 8.2, 10, 15, 22, 33, 47, 68, 100];
const MAX_SLOTS = 2;

/* =========================
   Levels
========================= */
const LEVELS = [
  { mode:"build",  label:"Warm-up", targetI:0.30, tol:0.02,  maxSafeI:0.55,
    hint:"Treffe den Zielstrom." },

  { mode:"build",  label:"Fein",    targetI:0.12, tol:0.015, maxSafeI:0.35,
    hint:"Tipp: Mit 3V brauchst du ca. 25Œ© (z.B. 22Œ© + 3,3Œ©)." },

  { mode:"mission", label:"Mission: Hell & sicher", targetI:0.45, tol:0.03, maxSafeI:0.60,
    mission:{ lampMin:0.65, heatMax:0.60 },
    hint:"Zielstrom + Lampe hell, aber W√§rme nicht zu hoch." },

  { mode:"mission", label:"Mission: Sparmodus", targetI:0.20, tol:0.02, maxSafeI:0.45,
    mission:{ lampMax:0.45, heatMax:0.45 },
    hint:"Zielstrom + Lampe nicht zu hell." },

  { mode:"diagnose", label:"Diagnose 1", targetI:0.30, tol:0.02, maxSafeI:0.55,
    diagnose:{
      presetVoltage: 12,
      presetResistors: [22, 10],
      lockResistors: true,
      allowBattery: true,
      goal:"Nur Batterie wechseln."
    },
    mc:{
      q:"Warum passt der Strom nicht?",
      options:[
        {t:"Batteriespannung ist zu gro√ü.", ok:true},
        {t:"Widerst√§nde sind zu gro√ü.", ok:false},
        {t:"Es fehlt ein Widerstand.", ok:false},
        {t:"Lampe ist kaputt.", ok:false},
      ],
      after:"W√§hle jetzt eine passendere Batterie."
    },
    hint:"Erst Diagnose, dann reparieren." },

  { mode:"diagnose", label:"Diagnose 2", targetI:0.20, tol:0.02, maxSafeI:0.45,
    diagnose:{
      presetVoltage: 6,
      presetResistors: [10],
      lockVoltage: true,
      allowResistors: true,
      goal:"Batterie bleibt, R anpassen."
    },
    mc:{
      q:"Was ist der Hauptfehler?",
      options:[
        {t:"Der Widerstand ist zu klein (Strom zu gro√ü).", ok:true},
        {t:"Die Batteriespannung ist zu klein.", ok:false},
        {t:"Der Widerstand ist zu gro√ü (Strom zu klein).", ok:false},
        {t:"Der Strommesser zeigt falsch.", ok:false},
      ],
      after:"F√ºge Widerst√§nde hinzu oder ersetze sie."
    },
    hint:"Diagnose ‚Üí dann Widerst√§nde korrigieren." },

  { mode:"diagnose", label:"Diagnose 3", targetI:0.12, tol:0.015, maxSafeI:0.35,
    diagnose:{
      presetVoltage: 4.5,
      presetResistors: [33],
      lockVoltage: true,
      allowResistors: true,
      goal:"Nur kleine √Ñnderung."
    },
    mc:{
      q:"Was passt am besten als Korrektur?",
      options:[
        {t:"Etwas mehr Widerstand hinzuf√ºgen (klein korrigieren).", ok:true},
        {t:"Widerstand entfernen (macht Strom noch gr√∂√üer).", ok:false},
        {t:"Batterie stark erh√∂hen.", ok:false},
        {t:"Batterie auf 1,5V senken (zu starke √Ñnderung).", ok:false},
      ],
      after:"Probiere eine kleine Widerstands-Erh√∂hung."
    },
    hint:"Diagnose hilft: Was passiert wenn R gr√∂√üer wird?" },
];

let levelIndex = 0;
let score = 0;

let voltage = null;
let resistors = [];

let heat = 0;
let lastTick = performance.now();
let overheated = false;

let mcAnswered = false;

/* =========================
   Helpers
========================= */
const $ = (id)=>document.getElementById(id);

function fmt(x, digits=2){
  const r = Number.isFinite(x) ? (Math.round(x * (10**digits)) / (10**digits)) : x;
  return String(r).replace(".", ",");
}
function clamp01(x){ return Math.max(0, Math.min(1, x)); }
function sumR(){ return resistors.reduce((a,b)=>a+b,0); }
function currentI(){
  const R = sumR();
  if(!voltage || R <= 0) return null;
  return voltage / R;
}
function lampBrightness(i){
  if(!Number.isFinite(i)) return 0;
  return clamp01(i / 0.6);
}
function hideResultBox(){ $("resultBox").classList.remove("show"); }
function showResultBox(calcText, pointsText){
  $("calcLine").innerHTML = calcText;
  $("pointsLine").innerHTML = pointsText;
  $("resultBox").classList.add("show");
}

/* =========================
   Visual components
========================= */
function resistorBands(ohms){
  const colors = ["#3b3b3b","#b3261e","#a05a00","#005bbb","#1b7f3a","#6a1b9a"];
  const h = Math.abs(Math.round(ohms*100)) % colors.length;
  return [colors[h], colors[(h+2)%colors.length], colors[(h+4)%colors.length]];
}
function renderResistor(ohms){
  const [c1,c2,c3] = resistorBands(ohms);
  return `
    <div class="resistor" title="${ohms} Œ©">
      <div class="lead"></div>
      <div class="body">
        <span class="band" style="left:18px;background:${c1}"></span>
        <span class="band" style="left:38px;background:${c2}"></span>
        <span class="band" style="left:58px;background:${c3}"></span>
      </div>
      <div class="lead"></div>
      <div class="ohm">${fmt(ohms,1)} Œ©</div>
    </div>
  `;
}
function renderBattery(v){
  const vStr = (Number.isInteger(v) ? String(v) : fmt(v,1));
  return `
    <div class="battery" title="Batterie ${vStr} V">
      <div class="cap"></div>
      <div style="display:flex;flex-direction:column;gap:1px">
        <div class="labelV">${vStr} V</div>
        <div class="sub">Batterie</div>
      </div>
      <div style="width:8px"></div>
    </div>
  `;
}
function renderLamp(){
  return `
    <div class="lampWrap">
      <div class="lamp" aria-label="Lampe"><div class="lampCore"></div></div>
      <div class="lampPct" id="lampPctInline">0%</div>
      <div class="lampLabel">Lampe</div>
    </div>
  `;
}

function setLampGlow(i){
  const lamp = $("circuitRow").querySelector(".lamp");
  const core = lamp?.querySelector(".lampCore");
  if(!lamp || !core) return;

  const b = lampBrightness(i ?? 0);
  lamp.style.boxShadow = `0 0 ${12 + 46*b}px rgba(255, 215, 120, ${0.12 + 0.55*b})`;
  core.style.background = `rgba(255, 200, 90, ${0.20 + 0.70*b})`;

  const pct = Math.round(b*100);
  $("lampFill").style.width = `${pct}%`;
  $("lampPct").textContent = `${pct}%`;
  const inline = $("lampPctInline");
  if(inline) inline.textContent = `${pct}%`;

  $("lampState").textContent = b < 0.05 ? "Aus" : b < 0.4 ? "Dunkel" : b < 0.75 ? "Hell" : "Sehr hell";
}

function setCurrentUI(i){
  const lvl = LEVELS[levelIndex];
  const target = lvl.targetI;
  const tol = lvl.tol;

  if(i === null){
    $("iNow").textContent = "‚Äì";
    $("iHint").textContent = "W√§hle Batterie + mind. 1 Widerstand.";
    $("iHint").className = "small";
    $("iFill").style.width = "0%";
    return;
  }

  $("iNow").textContent = `${fmt(i,2)} A`;
  const maxScale = lvl.maxSafeI * 1.2;
  const pct = Math.max(0, Math.min(1, i / maxScale));
  $("iFill").style.width = `${Math.round(pct*100)}%`;

  if(overheated){
    $("iHint").textContent = "√úberhitzt ‚ö†Ô∏è";
    $("iHint").className = "small warn";
    return;
  }

  const diff = i - target;
  if(Math.abs(diff) <= tol){
    $("iHint").textContent = "Im Ziel ‚úÖ";
    $("iHint").className = "small ok";
  } else if(i < target - tol){
    $("iHint").textContent = "Zu klein (mehr U oder weniger R).";
    $("iHint").className = "small low";
  } else {
    $("iHint").textContent = "Zu gro√ü (weniger U oder mehr R).";
    $("iHint").className = "small bad";
  }
}

/* =========================
   Locks + Diagnose Gate
========================= */
function currentLocks(){
  const lvl = LEVELS[levelIndex];
  const d = lvl.diagnose || {};
  const lockVoltage = !!d.lockVoltage;
  const lockResistors = !!d.lockResistors;
  const allowBattery = (lvl.mode !== "diagnose") ? true : !!d.allowBattery;
  const allowResistors = (lvl.mode !== "diagnose") ? true : !!d.allowResistors;
  const gate = (lvl.mode === "diagnose") ? mcAnswered : true;

  return {
    lockVoltage: lockVoltage || !gate,
    lockResistors: lockResistors || !gate,
    allowBattery: allowBattery && gate,
    allowResistors: allowResistors && gate
  };
}

function applyLocksToControls(){
  const { lockVoltage, lockResistors, allowBattery, allowResistors } = currentLocks();

  [...$("voltageBtns").querySelectorAll("button")].forEach(btn=>{
    btn.disabled = lockVoltage || !allowBattery;
  });

  const slotsFull = resistors.length >= MAX_SLOTS;

  [...$("resBtns").querySelectorAll("button")].forEach(btn=>{
    btn.disabled = lockResistors || !allowResistors || slotsFull;
  });

  $("undoBtn").disabled = (lockResistors || !allowResistors) || resistors.length === 0;

  const lvl = LEVELS[levelIndex];
  if(lvl.mode === "diagnose" && !mcAnswered){
    $("lockInfoV").textContent = "üîí Erst Diagnose beantworten, dann reparieren.";
    $("lockInfoR").textContent = "üîí Erst Diagnose beantworten, dann reparieren.";
  }else{
    $("lockInfoV").textContent = (lockVoltage && lvl.mode==="diagnose") ? "üîí Batterie fix." : "";
    if(slotsFull && !(lockResistors || !allowResistors)) {
      $("lockInfoR").textContent = `Max. ${MAX_SLOTS} Widerst√§nde.`;
    } else {
      $("lockInfoR").textContent = (lockResistors && lvl.mode==="diagnose") ? "üîí Widerst√§nde fix." : "";
    }
  }
}

/* =========================
   Render UI
========================= */
function renderPickers(){
  const vb = $("voltageBtns");
  const rb = $("resBtns");
  vb.innerHTML = "";
  rb.innerHTML = "";

  VOLTAGES.forEach(v=>{
    const b = document.createElement("button");
    b.className = "btn ghost";
    b.textContent = `${String(v).replace(".", ",")}V`;
    b.onclick = ()=>{ voltage = v; hideResultBox(); updateAll(); };
    vb.appendChild(b);
  });

  RESISTORS.forEach(r=>{
    const b = document.createElement("button");
    b.className = "btn ghost";
    b.textContent = `${String(r).replace(".", ",")}Œ©`;
    b.onclick = ()=>{
      if(resistors.length >= MAX_SLOTS) return;
      resistors.push(r);
      hideResultBox();
      updateAll();
    };
    rb.appendChild(b);
  });

  $("undoBtn").onclick = ()=>{ resistors.pop(); hideResultBox(); updateAll(); };
  $("resetBtn").onclick = ()=>{ startLevel(levelIndex); };
}

function renderBoard(){
  const row = $("circuitRow");

  const bat = voltage ? renderBattery(voltage) : `<div class="placeholder">Batterie?</div>`;
  const r1  = resistors[0] != null ? renderResistor(resistors[0]) : `<div class="placeholder">R1?</div>`;

  const hasR2 = resistors[1] != null;
  const r2 = hasR2 ? renderResistor(resistors[1]) : "";

  row.innerHTML = `
    ${bat}
    <div class="wireFlex"></div>
    ${r1}
    ${hasR2 ? `<div class="wireFlex"></div>${r2}` : ``}
    <div class="wireFlex"></div>
    ${renderLamp()}
  `;
}

function renderHeader(){
  const lvl = LEVELS[levelIndex];
  $("levelLabel").textContent = `${levelIndex+1}/${LEVELS.length} ‚Äì ${lvl.label}`;
  $("modeLabel").textContent =
    lvl.mode === "build" ? "Bauen" :
    lvl.mode === "mission" ? "MISSION" :
    "Diagnose";
  $("targetLabel").textContent = `${fmt(lvl.targetI,2)} A`;
  $("tolLabel").textContent = fmt(lvl.tol,2);
  $("scoreLabel").textContent = score;
}

function renderTask(){
  const lvl = LEVELS[levelIndex];

  $("taskTitle").innerHTML =
    lvl.mode === "build" ? "Aufgabe: Zielstrom" :
    lvl.mode === "mission" ? "<span class='mission'><b>MISSION</b></span>: Zusatzbedingungen" :
    "Fehlerdiagnose";

  const badges = [];
  badges.push(`<span class="badge">üéØ ${fmt(lvl.targetI,2)}A ¬±${fmt(lvl.tol,2)}</span>`);

  if(lvl.mode === "mission" && lvl.mission){
    const m = lvl.mission;
    if(m.lampMin != null) badges.push(`<span class="badge"><b>üí° ‚â•${Math.round(m.lampMin*100)}%</b></span>`);
    if(m.lampMax != null) badges.push(`<span class="badge"><b>üí° ‚â§${Math.round(m.lampMax*100)}%</b></span>`);
    if(m.heatMax != null) badges.push(`<span class="badge"><b>üå°Ô∏è ‚â§${Math.round(m.heatMax*100)}%</b></span>`);
  }

  if(lvl.mode === "diagnose" && lvl.diagnose){
    badges.push(`<span class="badge">üõ†Ô∏è ${lvl.diagnose.goal}</span>`);
  }

  $("taskBadges").innerHTML = badges.join("");
  $("taskHint").textContent = lvl.hint || "";
}

function renderMC(){
  const lvl = LEVELS[levelIndex];
  const box = $("mcBox");
  if(lvl.mode !== "diagnose" || !lvl.mc){
    box.style.display = "none";
    return;
  }

  box.style.display = "block";
  $("mcTitle").textContent = `Fehlerdiagnose: ${lvl.mc.q}`;
  $("mcHint").textContent = mcAnswered ? "‚úÖ Diagnose erledigt. Reparieren ist freigeschaltet." : "W√§hle eine Antwort, um zu starten.";

  const opts = $("mcOpts");
  opts.innerHTML = "";

  lvl.mc.options.forEach((o)=>{
    const d = document.createElement("div");
    d.className = "opt";
    d.textContent = o.t;
    d.onclick = ()=>{
      if(mcAnswered) return;

      [...opts.children].forEach(x=>x.classList.add("disabled"));

      if(o.ok){
        d.classList.add("correct");
        $("mcHint").textContent = `Richtig. ${lvl.mc.after || ""}`;
        mcAnswered = true;
      }else{
        d.classList.add("wrong");
        $("mcHint").textContent = "Nicht ganz. Ist der Strom zu gro√ü oder zu klein?";
        const correctIdx = lvl.mc.options.findIndex(x=>x.ok);
        if(correctIdx >= 0) opts.children[correctIdx].classList.add("correct");
        mcAnswered = true;
      }

      hideResultBox();
      updateAll();
    };
    opts.appendChild(d);
  });
}

/* =========================
   Heat loop
========================= */
function setHeatUI(){
  $("heatFill").style.width = `${Math.round(heat*100)}%`;
  $("overheatBox").classList.toggle("show", overheated);
}

function updateMeters(){
  const i = currentI();
  setCurrentUI(i);
  setLampGlow(i ?? 0);
}

function tick(now){
  const dt = Math.min(0.05, (now - lastTick) / 1000);
  lastTick = now;

  const lvl = LEVELS[levelIndex];
  const i = currentI();

  if(i !== null){
    const over = Math.max(0, i - lvl.maxSafeI);
    const rise = over > 0 ? (over / lvl.maxSafeI) * 1.7 : 0;
    const cool = 0.20;
    heat = heat + rise*dt - cool*dt;
    heat = Math.max(0, Math.min(1, heat));
    overheated = heat > 0.92;
  }else{
    heat = Math.max(0, heat - 0.28*dt);
    overheated = heat > 0.92;
  }

  setHeatUI();
  updateMeters();
  requestAnimationFrame(tick);
}

/* =========================
   Pass conditions + scoring
========================= */
function inTarget(i, lvl){
  if(i === null) return false;
  if(overheated) return false;
  return Math.abs(i - lvl.targetI) <= lvl.tol;
}
function missionOK(i, lvl){
  if(lvl.mode !== "mission" || !lvl.mission) return true;
  const m = lvl.mission;
  const b = lampBrightness(i ?? 0);
  if(m.lampMin != null && b < m.lampMin) return false;
  if(m.lampMax != null && b > m.lampMax) return false;
  if(m.heatMax != null && heat > m.heatMax) return false;
  return true;
}

/* =========================
   TRUE possible: Brute-force √ºber alle erlaubten Kombinationen
========================= */
const possibleCache = new Map();

function levelKey(lvl){
  return JSON.stringify({
    mode: lvl.mode,
    targetI: lvl.targetI,
    tol: lvl.tol,
    maxSafeI: lvl.maxSafeI,
    mission: lvl.mission || null,
    diagnose: lvl.diagnose || null,
    hasMc: !!lvl.mc
  });
}

function pointsForGivenSetup(i, lvl, usedResCount){
  const heatIdeal = 0;
  const diff = Math.abs(i - lvl.targetI);
  if(diff > lvl.tol) return 0;

  let pts = 0;
  pts += 120;

  if(lvl.mode === "mission"){
    pts += missionOK(i, lvl) ? 80 : 0;
  }
  if(lvl.mode === "diagnose" && lvl.mc){
    pts += 20;
  }

  pts += Math.round((1 - (diff / lvl.tol)) * 60);
  pts += Math.max(0, 28 - usedResCount * 6);
  pts += Math.round((1 - heatIdeal) * 18); // 18
  pts += Math.round(lampBrightness(i) * 30);

  return Math.max(0, pts);
}

function enumerateResistorCombosForLevel(lvl){
  const combos = [];

  if(lvl.mode === "diagnose" && lvl.diagnose?.lockResistors){
    combos.push((lvl.diagnose.presetResistors || []).slice(0, MAX_SLOTS));
    return combos;
  }

  for(const r1 of RESISTORS){
    combos.push([r1]);
  }
  if(MAX_SLOTS >= 2){
    for(const r1 of RESISTORS){
      for(const r2 of RESISTORS){
        combos.push([r1, r2]);
      }
    }
  }
  return combos;
}

function enumerateVoltagesForLevel(lvl){
  if(lvl.mode === "diagnose" && lvl.diagnose?.lockVoltage){
    return [lvl.diagnose.presetVoltage];
  }
  return VOLTAGES.slice();
}

function pointsPossible(lvl){
  const key = levelKey(lvl);
  if(possibleCache.has(key)) return possibleCache.get(key);

  let best = 0;

  const volts = enumerateVoltagesForLevel(lvl);
  const resCombos = enumerateResistorCombosForLevel(lvl);

  for(const U of volts){
    if(!Number.isFinite(U) || U <= 0) continue;

    for(const rs of resCombos){
      const R = rs.reduce((a,b)=>a+b,0);
      if(!(R > 0)) continue;

      const I = U / R;

      if(Math.abs(I - lvl.targetI) > lvl.tol) continue;
      if(!missionOK(I, lvl)) continue;

      const pts = pointsForGivenSetup(I, lvl, rs.length);
      if(pts > best) best = pts;
    }
  }

  possibleCache.set(key, best);
  return best;
}

/* pointsForAttempt benutzt jetzt pointsPossible(lvl) */
function pointsForAttempt(i, lvl){
  const possible = pointsPossible(lvl);

  if(i === null) return { pts:0, possible };
  if(overheated) return { pts:0, possible };

  let pts = 0;
  const diff = Math.abs(i - lvl.targetI);

  if(diff <= lvl.tol){
    pts = 120;

    if(lvl.mode === "mission"){
      pts += missionOK(i, lvl) ? 80 : 0;
    }
    if(lvl.mode === "diagnose" && lvl.mc){
      pts += 20;
    }

    pts += Math.round((1 - (diff / lvl.tol)) * 60);
    pts += Math.max(0, 28 - resistors.length*6);
    pts += Math.round((1 - heat) * 18);
    pts += Math.round(lampBrightness(i) * 30);
  }else{
    const maxDiff = lvl.tol * 4;
    if(diff < maxDiff){
      pts = Math.round((1 - diff/maxDiff) * 40);
    }
  }

  pts = Math.max(0, pts);
  return { pts, possible };
}

/* =========================
   Level start / reset
========================= */
function startLevel(i){
  possibleCache.clear();

  levelIndex = i;
  const lvl = LEVELS[levelIndex];

  heat = 0;
  overheated = false;

  mcAnswered = (lvl.mode !== "diagnose");

  if(lvl.mode === "diagnose" && lvl.diagnose){
    voltage = lvl.diagnose.presetVoltage ?? null;
    resistors = (lvl.diagnose.presetResistors ?? []).slice(0, MAX_SLOTS);
  }else{
    voltage = null;
    resistors = [];
  }

  hideResultBox();
  updateAll();
}

function updateAll(){
  renderHeader();
  renderTask();
  renderBoard();
  renderMC();
  applyLocksToControls();
  updateMeters();
  setHeatUI();
  $("nextBtn").disabled = true;
}

/* =========================
   Buttons
========================= */
$("checkBtn").onclick = ()=>{
  const lvl = LEVELS[levelIndex];
  const i = currentI();

  if(i === null){
    alert("Bitte Batterie w√§hlen + mindestens 1 Widerstand.");
    return;
  }

  const okTarget = inTarget(i, lvl);
  const ok = okTarget && missionOK(i, lvl);

  const { pts, possible } = pointsForAttempt(i, lvl);
  score += pts;
  $("scoreLabel").textContent = score;

  if(ok){
    const U = voltage;
    const R = sumR();
    const I = i;

    const calcText =
      `<span class="mono"><b>I</b> = <b>U</b> / <b>R</b> = ` +
      `${fmt(U,1)}V / ${fmt(R,1)}Œ© = ${fmt(I,2)}A</span>`;

    const pointsText =
      `<b>Punkte:</b> ${pts} / ${possible}`;

    showResultBox(calcText, pointsText);
    $("nextBtn").disabled = false;
  }else{
    hideResultBox();
    $("nextBtn").disabled = true;

    if(lvl.mode === "mission" && okTarget && !missionOK(i, lvl)){
      alert("Zielstrom getroffen ‚úÖ ‚Äì aber Mission noch nicht erf√ºllt (Lampe/W√§rme).");
    }
  }
};

$("nextBtn").onclick = ()=>{
  let next = levelIndex + 1;
  if(next >= LEVELS.length){
    alert(`Fertig! üéâ Punkte: ${score}\nDu startest wieder bei Level 1.`);
    score = 0;
    next = 0;
  }
  startLevel(next);
};

/* =========================
   Init
========================= */
function init(){
  renderPickers();
  startLevel(0);
  requestAnimationFrame(tick);
}
init();
</script>
</body>
</html>
