<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Stromkreis-Lernspiel ‚Äì kompakt, Mission & Diagnose</title>
<style>
  *{box-sizing:border-box;font-family:system-ui,-apple-system,Segoe UI,sans-serif}
  body{margin:0;background:#f3f3f3;display:flex;justify-content:center}
  .app{
    width:100%;max-width:1040px;background:#fff;margin:10px;padding:10px;
    border-radius:12px;box-shadow:0 2px 10px rgba(0,0,0,.08)
  }
  h1{margin:4px 0 8px;text-align:center;font-size:17px}

  .top{
    display:flex;justify-content:space-between;align-items:center;gap:8px;flex-wrap:wrap
  }
  .pill{
    display:inline-flex;align-items:center;gap:8px;
    padding:5px 9px;border-radius:999px;border:1px solid #ddd;background:#fafafa;
    font-weight:900;font-size:12px;color:#222
  }

  .grid{
    margin-top:10px;
    display:grid;
    grid-template-columns: 360px 1fr;
    gap:10px;
  }
  @media (max-width:920px){
    .grid{grid-template-columns:1fr}
  }

  .card{
    border:1px solid #e5e5e5;border-radius:12px;background:#fcfcfc;padding:10px
  }
  .title{font-weight:1100;margin-bottom:8px;font-size:13px}
  .small{font-size:12px;color:#555;font-weight:800;line-height:1.25}

  .btnRow{display:flex;gap:6px;flex-wrap:wrap}
  .btn{
    border:none;border-radius:10px;padding:9px 10px;
    font-weight:1100;cursor:pointer;font-size:12px;
    background:#007bff;color:#fff
  }
  .btn:hover{background:#0062cc}
  .btn.secondary{background:#222}
  .btn.secondary:hover{background:#000}
  .btn.ghost{background:#fff;color:#111;border:1px solid #ddd}
  .btn.ghost:hover{background:#f3f3f3}
  .btn:disabled{opacity:.55;cursor:not-allowed}

  .section{margin-top:10px}
  .label{font-weight:1100;font-size:12px;color:#333;margin-bottom:6px}
  .hr{height:1px;background:#e9e9e9;margin:10px 0}

  /* ===== Compact board ===== */
  .board{
    position:relative;
    border:1px solid #ddd;border-radius:12px;background:#fff;
    padding:10px;min-height:260px;overflow:hidden
  }
  .boardGrid{
    position:absolute;inset:0;
    background-image: radial-gradient(circle at 1px 1px, rgba(0,0,0,.05) 1px, transparent 0);
    background-size:18px 18px;
    opacity:.65;pointer-events:none;
  }
  .wire{
    position:absolute;height:5px;border-radius:999px;
    background:linear-gradient(90deg,#222,#444);
    box-shadow: inset 0 0 0 1px rgba(255,255,255,.10);
  }

  /* Smaller battery */
  .battery{
    width:118px;height:50px;border-radius:12px;
    background:linear-gradient(180deg,#ffd27f,#ffbe55);
    border:2px solid #333;
    display:flex;align-items:center;justify-content:space-between;
    padding:8px 10px;gap:8px
  }
  .battery .cap{width:14px;height:24px;border-radius:6px;background:#555;border:2px solid #333}
  .battery .label{font-weight:1100;font-size:13px}
  .battery .sub{font-size:11px;font-weight:900;color:#333}

  /* Smaller resistor */
  .resistor{
    width:128px;height:42px;border-radius:12px;
    border:2px solid #333;background:#fff;
    display:flex;align-items:center;justify-content:space-between;
    padding:6px 8px;gap:8px;position:relative;
  }
  .resistor .lead{width:18px;height:5px;border-radius:999px;background:#666}
  .resistor .body{
    flex:1;height:20px;border-radius:999px;border:2px solid #333;
    background:linear-gradient(180deg,#f1d7b2,#d9b483);
    position:relative;
  }
  .band{position:absolute;top:0;bottom:0;width:8px;border-radius:6px;opacity:.95}
  .resistor .ohm{
    position:absolute;right:7px;top:50%;transform:translateY(-50%);
    font-weight:1100;font-size:11px;background:rgba(255,255,255,.85);
    border:1px solid rgba(0,0,0,.15);border-radius:999px;padding:2px 7px;
  }

  /* Lamp */
  .lampWrap{display:flex;flex-direction:column;align-items:center;gap:6px}
  .lamp{
    width:74px;height:74px;border-radius:999px;
    border:2px solid #333;background:#f8f8f8;
    display:flex;align-items:center;justify-content:center;
    position:relative;
  }
  .lamp:before{
    content:"";
    position:absolute;inset:7px;border-radius:999px;
    background:radial-gradient(circle at 35% 35%, rgba(255,255,255,.95), rgba(255,255,255,.25));
    border:1px solid rgba(0,0,0,.08);
  }
  .lampCore{width:20px;height:20px;border-radius:999px;background:#999;z-index:1}
  .lampPct{font-size:12px;font-weight:1100}
  .lampLabel{font-size:11px;font-weight:900;color:#333}

  /* Meter compact */
  .meters{
    margin-top:10px;
    display:grid;
    grid-template-columns: 1fr 1fr 1fr;
    gap:10px;
  }
  @media (max-width:920px){
    .meters{grid-template-columns: 1fr}
  }
  .mCard{background:#fff;border:1px solid #e5e5e5;border-radius:12px;padding:10px}
  .mTitle{font-weight:1100;font-size:12px;margin-bottom:6px}
  .big{font-size:20px;font-weight:1200}
  .bar{height:10px;border-radius:999px;background:#eee;overflow:hidden;border:1px solid #ddd;margin-top:8px}
  .fill{height:100%;width:0%;background:#111;transition:width .25s ease}

  .ok{color:#1b7f3a}
  .bad{color:#b3261e}
  .low{color:#005bbb}
  .warn{color:#a05a00}

  .heatBox{
    margin-top:8px;padding:8px;border-radius:12px;
    border:1px solid #ffccaa;background:#fff4ec;color:#7a2c00;font-weight:1100;
    display:none
  }
  .heatBox.show{display:block}

  /* Mission / Diagnose compact */
  .taskBox{
    margin-top:8px;background:#fff;border:1px solid #e5e5e5;border-radius:12px;padding:9px
  }
  .taskTitle{font-weight:1200;font-size:13px;margin-bottom:4px}
  .badges{display:flex;gap:6px;flex-wrap:wrap;margin-top:6px}
  .badge{
    padding:4px 9px;border-radius:999px;border:1px solid #ddd;background:#fafafa;
    font-weight:1100;font-size:11px;
  }

  /* Diagnose MC */
  .mc{
    margin-top:10px;background:#fff;border:1px solid #e5e5e5;border-radius:12px;padding:9px
  }
  .mcTitle{font-weight:1200;font-size:13px;margin-bottom:6px}
  .opt{
    border:1px solid #ddd;border-radius:12px;padding:9px;background:#fafafa;
    cursor:pointer;font-weight:1100;font-size:12px;margin-top:7px
  }
  .opt:hover{background:#f2f2f2}
  .opt.correct{background:#d4edda;border-color:#28a745}
  .opt.wrong{background:#f8d7da;border-color:#dc3545}
  .opt.disabled{pointer-events:none;opacity:.95}

  .controls{display:flex;justify-content:space-between;gap:8px;flex-wrap:wrap;margin-top:10px}
</style>
</head>

<body>
<div class="app">
  <h1>Stromkreis-Lernspiel ‚ö° (kompakt)</h1>

  <div class="top">
    <div class="pill">Level: <b id="levelLabel">1</b></div>
    <div class="pill">Modus: <b id="modeLabel">Bauen</b></div>
    <div class="pill">Zielstrom: <b id="targetLabel">‚Äì</b> (¬± <span id="tolLabel">‚Äì</span>)</div>
    <div class="pill">Punkte: <b id="scoreLabel">0</b></div>
  </div>

  <div class="grid">
    <!-- LEFT: Controls + Task -->
    <div class="card">
      <div class="title">Bauteile</div>

      <div class="section">
        <div class="label">Batterien</div>
        <div class="btnRow" id="voltageBtns"></div>
        <div class="small" id="lockInfoV" style="margin-top:6px"></div>
      </div>

      <div class="section">
        <div class="label">Widerst√§nde (Reihe)</div>
        <div class="btnRow" id="resBtns"></div>
        <div class="small" id="lockInfoR" style="margin-top:6px"></div>
      </div>

      <div class="section btnRow">
        <button class="btn ghost" id="undoBtn">Undo</button>
        <button class="btn secondary" id="resetBtn">Reset</button>
      </div>

      <div class="taskBox">
        <div class="taskTitle" id="taskTitle">Aufgabe</div>
        <div class="badges" id="taskBadges"></div>
        <div class="small" id="taskHint" style="margin-top:6px"></div>
        <div class="small" style="margin-top:8px">
          <b>Didaktik:</b> Denk in 2 Schritten: <b>1) R gesamt</b> ‚Üí <b>2) I = U/R</b>.
        </div>
      </div>

      <div class="mc" id="mcBox" style="display:none">
        <div class="mcTitle">Fehlerdiagnose: Was ist der Hauptfehler?</div>
        <div id="mcOpts"></div>
        <div class="small" id="mcHint" style="margin-top:8px"></div>
      </div>
    </div>

    <!-- RIGHT: Board + Meters -->
    <div class="card">
      <div class="title">Schaltkreis</div>

      <div class="board" id="board">
        <div class="boardGrid"></div>

        <div class="wire" style="left:56px;top:100px;width:120px;"></div>
        <div class="wire" style="left:240px;top:100px;width:120px;"></div>
        <div class="wire" style="left:424px;top:100px;width:120px;"></div>

        <div style="position:absolute;left:24px;top:76px" id="batterySpot"></div>
        <div style="position:absolute;left:188px;top:82px;display:flex;gap:8px;flex-wrap:wrap" id="resSpot"></div>
        <div style="position:absolute;left:580px;top:52px" id="lampSpot"></div>
      </div>

      <div class="meters">
        <div class="mCard">
          <div class="mTitle">Strom</div>
          <div class="big" id="iNow">‚Äì</div>
          <div class="bar"><div class="fill" id="iFill"></div></div>
          <div class="small" id="iHint" style="margin-top:8px"></div>
        </div>

        <div class="mCard">
          <div class="mTitle">Lampe</div>
          <div class="big" id="lampState">‚Äì</div>
          <div class="bar"><div class="fill" id="lampFill"></div></div>
          <div class="small" style="margin-top:8px">Helligkeit: <b id="lampPct">0%</b></div>
        </div>

        <div class="mCard">
          <div class="mTitle">W√§rme</div>
          <div class="bar"><div class="fill" id="heatFill"></div></div>
          <div class="heatBox" id="overheatBox">√úberhitzt! ‚ö†Ô∏è Weniger U oder mehr R.</div>
          <div class="small" style="margin-top:8px">Ziel: nicht √ºberhitzen.</div>
        </div>
      </div>

      <div class="controls">
        <button class="btn" id="checkBtn">Pr√ºfen</button>
        <button class="btn" id="nextBtn" disabled>Weiter</button>
      </div>
    </div>
  </div>
</div>

<script>
/* =========================
   Bauteile
========================= */
const VOLTAGES = [1.5, 3, 4.5, 6, 9, 12];
const RESISTORS = [1, 2.2, 3.3, 4.7, 5.6, 6.8, 10, 15, 22, 33, 47, 68, 100];

/* =========================
   Levels
========================= */
const LEVELS = [
  { mode:"build",  label:"Warm-up", targetI:0.30, tol:0.02, maxSafeI:0.55,
    hint:"Treffe den Zielstrom." },

  { mode:"build",  label:"Fein", targetI:0.12, tol:0.015, maxSafeI:0.35,
    hint:"Kleiner Strom ‚Üí meist gr√∂√üerer Widerstand." },

  { mode:"mission", label:"Mission: Hell & sicher", targetI:0.45, tol:0.03, maxSafeI:0.60,
    mission:{ lampMin:0.65, heatMax:0.60 },
    hint:"Zielstrom + Lampe hell, aber W√§rme nicht zu hoch." },

  { mode:"mission", label:"Mission: Sparmodus", targetI:0.20, tol:0.02, maxSafeI:0.45,
    mission:{ lampMax:0.45, heatMax:0.45 },
    hint:"Zielstrom + Lampe nicht zu hell." },

  { mode:"diagnose", label:"Diagnose 1", targetI:0.30, tol:0.02, maxSafeI:0.55,
    diagnose:{
      presetVoltage: 12,
      presetResistors: [22, 10], // zu hoch
      lockResistors: true,
      allowBattery: true,
      goal:"Nur Batterie wechseln."
    },
    mc:{
      q:"Warum passt der Strom nicht?",
      options:[
        {t:"Batteriespannung ist zu gro√ü.", ok:true},
        {t:"Widerst√§nde sind zu gro√ü.", ok:false},
        {t:"Es fehlt ein Widerstand.", ok:false},
        {t:"Lampe ist kaputt.", ok:false},
      ],
      after:"W√§hle jetzt eine passendere Batterie."
    },
    hint:"Erst Diagnose anklicken, dann reparieren." },

  { mode:"diagnose", label:"Diagnose 2", targetI:0.20, tol:0.02, maxSafeI:0.45,
    diagnose:{
      presetVoltage: 6,
      presetResistors: [10],     // viel zu hoch
      lockVoltage: true,
      allowResistors: true,
      goal:"Batterie bleibt, R anpassen."
    },
    mc:{
      q:"Was ist der Hauptfehler?",
      options:[
        {t:"Der Widerstand ist zu klein (Strom zu gro√ü).", ok:true},
        {t:"Die Batteriespannung ist zu klein.", ok:false},
        {t:"Der Widerstand ist zu gro√ü (Strom zu klein).", ok:false},
        {t:"Der Strommesser zeigt falsch.", ok:false},
      ],
      after:"F√ºge Widerst√§nde hinzu oder ersetze sie."
    },
    hint:"Diagnose ‚Üí dann Widerst√§nde korrigieren." },

  { mode:"diagnose", label:"Diagnose 3 (knapp daneben)", targetI:0.12, tol:0.015, maxSafeI:0.35,
    diagnose:{
      presetVoltage: 4.5,
      presetResistors: [33],     // knapp zu hoch
      lockVoltage: true,
      allowResistors: true,
      goal:"Nur kleine √Ñnderung."
    },
    mc:{
      q:"Was passt am besten als Korrektur?",
      options:[
        {t:"Etwas mehr Widerstand hinzuf√ºgen (klein korrigieren).", ok:true},
        {t:"Widerstand entfernen (macht Strom noch gr√∂√üer).", ok:false},
        {t:"Batterie stark erh√∂hen.", ok:false},
        {t:"Batterie auf 1,5V senken (zu starke √Ñnderung).", ok:false},
      ],
      after:"Probiere eine kleine Widerstands-Erh√∂hung."
    },
    hint:"Diagnose hilft: Was passiert wenn R gr√∂√üer wird?" },
];

let levelIndex = 0;
let score = 0;

let voltage = null;
let resistors = [];

let heat = 0; // 0..1
let lastTick = performance.now();
let overheated = false;

let mcAnswered = false; // must answer MC before fixing in diagnose levels

/* =========================
   Helpers
========================= */
const $ = (id)=>document.getElementById(id);
function fmt(x, digits=2){
  const r = Number.isFinite(x) ? (Math.round(x * (10**digits)) / (10**digits)) : x;
  return String(r).replace(".", ",");
}
function sumR(){ return resistors.reduce((a,b)=>a+b,0); }
function currentI(){
  const R = sumR();
  if(!voltage || R <= 0) return null;
  return voltage / R;
}
function lampBrightness(i){
  if(!Number.isFinite(i)) return 0;
  return Math.max(0, Math.min(1, i / 0.6));
}

/* =========================
   Compact visuals
========================= */
function resistorBands(ohms){
  const colors = ["#3b3b3b","#b3261e","#a05a00","#005bbb","#1b7f3a","#6a1b9a"];
  const h = Math.abs(Math.round(ohms*100)) % colors.length;
  return [colors[h], colors[(h+2)%colors.length], colors[(h+4)%colors.length]];
}
function renderResistor(ohms){
  const [c1,c2,c3] = resistorBands(ohms);
  return `
    <div class="resistor" title="${ohms} Œ©">
      <div class="lead"></div>
      <div class="body">
        <span class="band" style="left:18px;background:${c1}"></span>
        <span class="band" style="left:38px;background:${c2}"></span>
        <span class="band" style="left:58px;background:${c3}"></span>
      </div>
      <div class="lead"></div>
      <div class="ohm">${fmt(ohms,1)} Œ©</div>
    </div>
  `;
}
function renderBattery(v){
  const vStr = (Number.isInteger(v) ? String(v) : fmt(v,1));
  return `
    <div class="battery" title="Batterie ${vStr} V">
      <div class="cap"></div>
      <div style="display:flex;flex-direction:column;gap:1px">
        <div class="label">${vStr} V</div>
        <div class="sub">Batterie</div>
      </div>
      <div style="width:8px"></div>
    </div>
  `;
}
function renderLamp(){
  return `
    <div class="lampWrap">
      <div class="lamp" aria-label="Lampe"><div class="lampCore"></div></div>
      <div class="lampPct" id="lampPctInline">0%</div>
      <div class="lampLabel">Lampe</div>
    </div>
  `;
}

function setLampGlow(i){
  const lamp = $("lampSpot").querySelector(".lamp");
  const core = lamp?.querySelector(".lampCore");
  if(!lamp || !core) return;

  const b = lampBrightness(i ?? 0);
  lamp.style.boxShadow = `0 0 ${12 + 46*b}px rgba(255, 215, 120, ${0.12 + 0.55*b})`;
  core.style.background = `rgba(255, 200, 90, ${0.20 + 0.70*b})`;

  const pct = Math.round(b*100);
  $("lampFill").style.width = `${pct}%`;
  $("lampPct").textContent = `${pct}%`;
  const inline = $("lampPctInline");
  if(inline) inline.textContent = `${pct}%`;

  $("lampState").textContent = b < 0.05 ? "Aus" : b < 0.4 ? "Dunkel" : b < 0.75 ? "Hell" : "Sehr hell";
}

function setCurrentUI(i){
  const lvl = LEVELS[levelIndex];
  const target = lvl.targetI;
  const tol = lvl.tol;

  if(i === null){
    $("iNow").textContent = "‚Äì";
    $("iHint").textContent = "W√§hle Batterie + mind. 1 Widerstand.";
    $("iHint").className = "small";
    $("iFill").style.width = "0%";
    return;
  }

  $("iNow").textContent = `${fmt(i,2)} A`;
  const maxScale = lvl.maxSafeI * 1.2;
  const pct = Math.max(0, Math.min(1, i / maxScale));
  $("iFill").style.width = `${Math.round(pct*100)}%`;

  if(overheated){
    $("iHint").textContent = "√úberhitzt ‚ö†Ô∏è";
    $("iHint").className = "small warn";
    return;
  }

  const diff = i - target;
  if(Math.abs(diff) <= tol){
    $("iHint").textContent = "Im Ziel ‚úÖ";
    $("iHint").className = "small ok";
  } else if(i < target - tol){
    $("iHint").textContent = "Zu klein (mehr U oder weniger R).";
    $("iHint").className = "small low";
  } else {
    $("iHint").textContent = "Zu gro√ü (weniger U oder mehr R).";
    $("iHint").className = "small bad";
  }
}

/* =========================
   Locks + Diagnose Gate
========================= */
function currentLocks(){
  const lvl = LEVELS[levelIndex];
  const d = lvl.diagnose || {};
  const lockVoltage = !!d.lockVoltage;
  const lockResistors = !!d.lockResistors;
  const allowBattery = (lvl.mode !== "diagnose") ? true : !!d.allowBattery;
  const allowResistors = (lvl.mode !== "diagnose") ? true : !!d.allowResistors;

  // In Diagnose: erst MC beantworten, dann "freischalten"
  const gate = (lvl.mode === "diagnose") ? mcAnswered : true;

  return {
    lockVoltage: lockVoltage || !gate,
    lockResistors: lockResistors || !gate,
    allowBattery: allowBattery && gate,
    allowResistors: allowResistors && gate
  };
}

function applyLocksToControls(){
  const { lockVoltage, lockResistors, allowBattery, allowResistors } = currentLocks();

  [...$("voltageBtns").querySelectorAll("button")].forEach(btn=>{
    btn.disabled = lockVoltage || !allowBattery;
  });
  [...$("resBtns").querySelectorAll("button")].forEach(btn=>{
    btn.disabled = lockResistors || !allowResistors;
  });

  $("undoBtn").disabled = lockResistors || !allowResistors || resistors.length === 0;

  const lvl = LEVELS[levelIndex];
  if(lvl.mode === "diagnose" && !mcAnswered){
    $("lockInfoV").textContent = "üîí Erst Diagnose beantworten, dann reparieren.";
    $("lockInfoR").textContent = "üîí Erst Diagnose beantworten, dann reparieren.";
  }else{
    $("lockInfoV").textContent = (lockVoltage && lvl.mode==="diagnose") ? "üîí Batterie fix." : "";
    $("lockInfoR").textContent = (lockResistors && lvl.mode==="diagnose") ? "üîí Widerst√§nde fix." : "";
  }
}

/* =========================
   Render UI
========================= */
function renderPickers(){
  const vb = $("voltageBtns");
  const rb = $("resBtns");
  vb.innerHTML = "";
  rb.innerHTML = "";

  VOLTAGES.forEach(v=>{
    const b = document.createElement("button");
    b.className = "btn ghost";
    b.textContent = `${String(v).replace(".", ",")}V`;
    b.onclick = ()=>{ voltage = v; updateAll(); };
    vb.appendChild(b);
  });

  RESISTORS.forEach(r=>{
    const b = document.createElement("button");
    b.className = "btn ghost";
    b.textContent = `${String(r).replace(".", ",")}Œ©`;
    b.onclick = ()=>{ resistors.push(r); updateAll(); };
    rb.appendChild(b);
  });

  $("undoBtn").onclick = ()=>{ resistors.pop(); updateAll(); };
  $("resetBtn").onclick = ()=>{ startLevel(levelIndex); };
}

function renderBoard(){
  $("batterySpot").innerHTML = voltage ? renderBattery(voltage) : `<div class="small">‚¨ÖÔ∏è Batterie</div>`;
  $("resSpot").innerHTML = resistors.length ? resistors.map(renderResistor).join("") : `<div class="small">‚¨ÖÔ∏è Widerst√§nde</div>`;
  $("lampSpot").innerHTML = renderLamp();
}

function renderHeader(){
  const lvl = LEVELS[levelIndex];
  $("levelLabel").textContent = `${levelIndex+1}/${LEVELS.length} ‚Äì ${lvl.label}`;
  $("modeLabel").textContent =
    lvl.mode === "build" ? "Bauen" :
    lvl.mode === "mission" ? "Mission" :
    "Diagnose";

  $("targetLabel").textContent = `${fmt(lvl.targetI,2)} A`;
  $("tolLabel").textContent = fmt(lvl.tol,2);
  $("scoreLabel").textContent = score;
}

function renderTask(){
  const lvl = LEVELS[levelIndex];

  $("taskTitle").textContent =
    lvl.mode === "build" ? "Aufgabe: Zielstrom" :
    lvl.mode === "mission" ? "Mission" :
    "Fehlerdiagnose";

  const badges = [];
  badges.push(`<span class="badge">üéØ ${fmt(lvl.targetI,2)}A ¬±${fmt(lvl.tol,2)}</span>`);

  if(lvl.mode === "mission" && lvl.mission){
    const m = lvl.mission;
    if(m.lampMin != null) badges.push(`<span class="badge">üí° ‚â•${Math.round(m.lampMin*100)}%</span>`);
    if(m.lampMax != null) badges.push(`<span class="badge">üí° ‚â§${Math.round(m.lampMax*100)}%</span>`);
    if(m.heatMax != null) badges.push(`<span class="badge">üå°Ô∏è ‚â§${Math.round(m.heatMax*100)}%</span>`);
  }

  if(lvl.mode === "diagnose" && lvl.diagnose){
    badges.push(`<span class="badge">üõ†Ô∏è ${lvl.diagnose.goal}</span>`);
  }

  $("taskBadges").innerHTML = badges.join("");
  $("taskHint").textContent = lvl.hint || "";
}

function renderMC(){
  const lvl = LEVELS[levelIndex];
  const box = $("mcBox");
  if(lvl.mode !== "diagnose" || !lvl.mc){
    box.style.display = "none";
    return;
  }

  box.style.display = "block";
  $("mcHint").textContent = mcAnswered ? "‚úÖ Diagnose erledigt. Reparieren ist freigeschaltet." : "W√§hle eine Antwort, um zu starten.";
  box.querySelector(".mcTitle").textContent = `Fehlerdiagnose: ${lvl.mc.q}`;

  const opts = $("mcOpts");
  opts.innerHTML = "";

  lvl.mc.options.forEach((o)=>{
    const d = document.createElement("div");
    d.className = "opt";
    d.textContent = o.t;
    d.onclick = ()=>{
      if(mcAnswered) return;

      // disable all
      [...opts.children].forEach(x=>x.classList.add("disabled"));

      if(o.ok){
        d.classList.add("correct");
        $("mcHint").textContent = `Richtig. ${lvl.mc.after || ""}`;
        mcAnswered = true;
      }else{
        d.classList.add("wrong");
        $("mcHint").textContent = "Nicht ganz. Schau: Ist der Strom zu gro√ü oder zu klein?";
        // show correct one
        const correctIdx = lvl.mc.options.findIndex(x=>x.ok);
        if(correctIdx >= 0) opts.children[correctIdx].classList.add("correct");
        // still allow to proceed after one wrong? didactically: allow, but no points bonus
        mcAnswered = true;
      }

      updateAll();
    };
    opts.appendChild(d);
  });
}

/* =========================
   Heat loop
========================= */
function setHeatUI(){
  $("heatFill").style.width = `${Math.round(heat*100)}%`;
  $("overheatBox").classList.toggle("show", overheated);
}

function updateMeters(){
  const i = currentI();
  setCurrentUI(i);
  setLampGlow(i ?? 0);
}

function tick(now){
  const dt = Math.min(0.05, (now - lastTick) / 1000);
  lastTick = now;

  const lvl = LEVELS[levelIndex];
  const i = currentI();

  if(i !== null){
    const over = Math.max(0, i - lvl.maxSafeI);
    const rise = over > 0 ? (over / lvl.maxSafeI) * 1.7 : 0;
    const cool = 0.20;
    heat = heat + rise*dt - cool*dt;
    heat = Math.max(0, Math.min(1, heat));
    overheated = heat > 0.92;
  }else{
    heat = Math.max(0, heat - 0.28*dt);
    overheated = heat > 0.92;
  }

  setHeatUI();
  updateMeters();
  requestAnimationFrame(tick);
}

/* =========================
   Level start / reset
========================= */
function startLevel(i){
  levelIndex = i;
  const lvl = LEVELS[levelIndex];

  heat = 0;
  overheated = false;

  mcAnswered = (lvl.mode !== "diagnose"); // only diagnose needs MC first

  if(lvl.mode === "diagnose" && lvl.diagnose){
    voltage = lvl.diagnose.presetVoltage ?? null;
    resistors = (lvl.diagnose.presetResistors ?? []).slice();
  }else{
    voltage = null;
    resistors = [];
  }

  updateAll();
}

function updateAll(){
  renderHeader();
  renderTask();
  renderBoard();
  renderMC();
  applyLocksToControls();
  updateMeters();
  setHeatUI();
  $("nextBtn").disabled = true;
}

/* =========================
   Pass conditions + scoring
========================= */
function inTarget(i, lvl){
  if(i === null) return false;
  if(overheated) return false;
  return Math.abs(i - lvl.targetI) <= lvl.tol;
}
function missionOK(i, lvl){
  if(lvl.mode !== "mission" || !lvl.mission) return true;
  const m = lvl.mission;
  const b = lampBrightness(i ?? 0);

  if(m.lampMin != null && b < m.lampMin) return false;
  if(m.lampMax != null && b > m.lampMax) return false;
  if(m.heatMax != null && heat > m.heatMax) return false;

  return true;
}
function pointsForAttempt(i, lvl){
  if(i === null) return 0;
  if(overheated) return 0;

  let pts = 0;
  const diff = Math.abs(i - lvl.targetI);

  if(diff <= lvl.tol){
    pts = 120;

    // mission bonus
    if(lvl.mode === "mission"){
      pts += missionOK(i, lvl) ? 80 : 10;
    }

    // diagnose bonus: if MC correct, bonus; if wrong, less
    if(lvl.mode === "diagnose" && lvl.mc){
      // we can't know if correct after enabling, so approximate:
      // award small constant; classroom friendly and avoids storing extra state
      pts += 20;
    }

    // closeness + simplicity + cool
    pts += Math.round((1 - (diff / lvl.tol)) * 60);
    pts += Math.max(0, 28 - resistors.length*6);
    pts += Math.round((1 - heat) * 18);
  }else{
    const maxDiff = lvl.tol * 4;
    if(diff < maxDiff){
      pts = Math.round((1 - diff/maxDiff) * 40);
    }
  }
  return Math.max(0, pts);
}

/* =========================
   Buttons
========================= */
$("checkBtn").onclick = ()=>{
  const lvl = LEVELS[levelIndex];
  const i = currentI();

  if(i === null){
    alert("Bitte Batterie w√§hlen + mindestens 1 Widerstand.");
    return;
  }

  const okTarget = inTarget(i, lvl);
  const okMission = missionOK(i, lvl);
  const ok = okTarget && okMission;

  const pts = pointsForAttempt(i, lvl);
  score += pts;
  $("scoreLabel").textContent = score;

  if(lvl.mode === "mission" && okTarget && !okMission){
    alert("Zielstrom getroffen ‚úÖ ‚Äì aber Mission noch nicht erf√ºllt (Lampe/W√§rme).");
  }

  $("nextBtn").disabled = !ok;
};

$("nextBtn").onclick = ()=>{
  let next = levelIndex + 1;
  if(next >= LEVELS.length){
    alert(`Fertig! üéâ Punkte: ${score}\nDu startest wieder bei Level 1.`);
    score = 0;
    next = 0;
  }
  startLevel(next);
};

/* =========================
   Init
========================= */
renderPickers();
startLevel(0);
requestAnimationFrame(tick);
</script>
</body>
</html>

